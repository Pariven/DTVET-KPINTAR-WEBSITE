<!DOCTYPE html>
<html>
<head>
    <title>Authentication Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4">Auth Flow Test</h1>
        
        <div class="space-y-4">
            <button id="testLogin" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                Test Login
            </button>
            
            <button id="checkAuth" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">
                Check Authentication Status
            </button>
            
            <button id="testPayment" class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600">
                Test Payment API
            </button>
            
            <button id="clearAuth" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600">
                Clear Auth Data
            </button>
        </div>
        
        <div id="results" class="mt-6 p-4 bg-gray-50 rounded min-h-[200px] text-sm">
            <h3 class="font-bold">Results:</h3>
            <div id="output"></div>
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="mb-1">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        document.getElementById('testLogin').addEventListener('click', async () => {
            log('Testing login...');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Login successful!');
                    log(`Token: ${data.token.substring(0, 30)}...`);
                    log(`User: ${data.user.name} (${data.user.email})`);
                    
                    // Store in localStorage like the real login form
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userEmail', data.user.email);
                    localStorage.setItem('userName', data.user.name);
                } else {
                    const error = await response.json();
                    log(`âŒ Login failed: ${error.message}`);
                }
            } catch (error) {
                log(`âŒ Login error: ${error.message}`);
            }
        });
        
        document.getElementById('checkAuth').addEventListener('click', () => {
            log('Checking authentication status...');
            const token = localStorage.getItem('token');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userEmail = localStorage.getItem('userEmail');
            const userName = localStorage.getItem('userName');
            
            log(`Token: ${token ? `${token.substring(0, 30)}...` : 'None'}`);
            log(`Logged In: ${isLoggedIn}`);
            log(`Email: ${userEmail || 'None'}`);
            log(`Name: ${userName || 'None'}`);
            log(`Cookies: ${document.cookie || 'None'}`);
        });
        
        document.getElementById('testPayment').addEventListener('click', async () => {
            log('Testing payment API...');
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('âŒ No token found. Please login first.');
                return;
            }
            
            try {
                const response = await fetch('/api/stripe/checkout-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        items: [{
                            certificationId: 'test',
                            certificationName: 'Test Certification',
                            price: 10.00,
                            logoUrl: ''
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Payment API successful!');
                    log(`Session ID: ${data.sessionId}`);
                    log(`URL: ${data.url.substring(0, 50)}...`);
                } else {
                    const error = await response.json();
                    log(`âŒ Payment API failed (${response.status}): ${error.error}`);
                }
            } catch (error) {
                log(`âŒ Payment API error: ${error.message}`);
            }
        });
        
        document.getElementById('clearAuth').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('auth-token');
            log('ðŸ§¹ All authentication data cleared');
        });
        
        // Initial check
        setTimeout(() => {
            document.getElementById('checkAuth').click();
        }, 100);
    </script>
</body>
</html>